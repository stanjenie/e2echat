<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" href="style.css"></link>
<script src="aes.js"></script>
<title>Messenger</title>
</head>
<body onload="setInterval(function () {update()}, 5000)">


<svg height="100" version="1.1" viewBox="0.0 0.0 962.4514435695538 294.37270341207346" fill="none" stroke="none" stroke-linecap="square" stroke-miterlimit="10" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg"><clipPath id="p.0"><path d="m0 0l962.4514 0l0 294.3727l-962.4514 0l0 -294.3727z" clip-rule="nonzero"/></clipPath><g clip-path="url(#p.0)"><path fill="#000000" fill-opacity="0.0" d="m0 0l962.4514 0l0 294.3727l-962.4514 0z" fill-rule="evenodd"/><path fill="#ff9900" d="m45.440945 165.4357l0 0c0 -50.8276 41.37312 -92.0315 92.40944 -92.0315l0 0c24.508514 0 48.013214 9.696152 65.34335 26.955406c17.33014 17.259247 27.066101 40.667816 27.066101 65.076096l0 0c0 50.82759 -41.373123 92.031494 -92.409454 92.031494l0 0c-51.036324 0 -92.40944 -41.203903 -92.40944 -92.031494z" fill-rule="evenodd"/><path fill="#ffe599" d="m55.30157 129.90427l-8.236221 -87.6693l75.732285 44.992123z" fill-rule="evenodd"/><path stroke="#ff9900" stroke-width="16.0" stroke-linejoin="round" stroke-linecap="butt" d="m55.30157 129.90427l-8.236221 -87.6693l75.732285 44.992123z" fill-rule="evenodd"/><path fill="#ffe599" d="m150.24582 87.0548l75.85826 -44.771656l-8.551178 87.70079z" fill-rule="evenodd"/><path stroke="#ff9900" stroke-width="16.0" stroke-linejoin="round" stroke-linecap="butt" d="m150.24582 87.0548l75.85826 -44.771656l-8.551178 87.70079z" fill-rule="evenodd"/><path fill="#ffffff" d="m217.12599 179.22835l0 0c0 24.120972 -14.939331 46.39241 -39.146057 58.358643c-24.206741 11.966248 -53.968636 11.792206 -77.986206 -0.45603943c-24.01757 -12.248245 -38.607574 -34.692352 -38.230724 -58.811127l77.67795 0.90852356z" fill-rule="evenodd"/><path fill="#000000" fill-opacity="0.0" d="m69.755905 105.68767l723.7165 0l0 96.944885l-723.7165 0z" fill-rule="evenodd"/><path fill="#000000" d="m82.349655 154.50267l11.75 -24.96875l6.96875 0l11.4375 24.96875l-8.875 0l-6.1875 -15.28125l-6.15625 15.28125l-8.9375 0zm72.9375 0l11.75 -24.96875l6.96875 0l11.4375 24.96875l-8.875 0l-6.1875 -15.28125l-6.15625 15.28125l-8.9375 0z" fill-rule="nonzero"/><path fill="#000000" fill-opacity="0.0" d="m165.18968 203.55797l0 0c-6.4529114 7.250641 -15.52182 11.640915 -25.2117 12.205002c-9.689865 0.5640869 -19.206955 -2.744217 -26.457596 -9.197128l24.330704 -27.338577z" fill-rule="evenodd"/><path fill="#000000" fill-opacity="0.0" d="m165.18968 203.55797l0 0c-6.4529114 7.250641 -15.52182 11.640915 -25.2117 12.205002c-9.689865 0.5640869 -19.206955 -2.744217 -26.457596 -9.197128" fill-rule="evenodd"/><path stroke="#000000" stroke-width="8.0" stroke-linejoin="round" stroke-linecap="butt" d="m165.18968 203.55797l0 0c-6.4529114 7.250641 -15.52182 11.640915 -25.2117 12.205002c-9.689865 0.5640869 -19.206955 -2.744217 -26.457596 -9.197128" fill-rule="evenodd"/><path fill="#000000" d="m129.19685 181.79265l0 0c0 -4.774872 3.5746613 -8.64566 7.984253 -8.64566l0 0c2.1175537 0 4.1483765 0.9108734 5.6457214 2.532257c1.4973297 1.6213684 2.3385315 3.8204346 2.3385315 6.1134033l0 0c0 4.774872 -3.5746765 8.645676 -7.984253 8.645676l0 0c-4.4095917 0 -7.984253 -3.8708038 -7.984253 -8.645676z" fill-rule="evenodd"/><path stroke="#000000" stroke-width="1.0" stroke-linejoin="round" stroke-linecap="butt" d="m129.19685 181.79265l0 0c0 -4.774872 3.5746613 -8.64566 7.984253 -8.64566l0 0c2.1175537 0 4.1483765 0.9108734 5.6457214 2.532257c1.4973297 1.6213684 2.3385315 3.8204346 2.3385315 6.1134033l0 0c0 4.774872 -3.5746765 8.645676 -7.984253 8.645676l0 0c-4.4095917 0 -7.984253 -3.8708038 -7.984253 -8.645676z" fill-rule="evenodd"/><path fill="#000000" fill-opacity="0.0" d="m243.75853 87.98688l689.3543 0l0 174.51968l-689.3543 0z" fill-rule="evenodd"/><path fill="#ff9900" d="m272.7898 220.5075q-3.390625 0 -5.296875 -2.40625q-1.890625 -2.421875 -1.171875 -5.78125l16.78125 -78.96875q0.65625 -3.09375 3.21875 -5.28125q2.578125 -2.1875 5.734375 -2.1875q3.40625 0 5.359375 2.484375q1.953125 2.46875 1.234375 5.828125l-7.453125 35.03125l48.765625 -40.796875q0.984375 -0.921875 2.609375 -1.734375q1.625 -0.8125 3.5 -0.8125q3.25 0 5.234375 2.390625q1.984375 2.390625 0.875 5.71875q-0.9375 3.0 -2.8125 4.53125l-34.5 28.359375l23.984375 41.28125q1.40625 2.46875 0.859375 5.078125q-0.46875 3.0 -3.0625 5.140625q-2.59375 2.125 -5.75 2.125q-4.171875 0 -5.859375 -3.34375l-22.875 -40.015625l-15.359375 12.75l-4.9375 23.265625q-0.65625 3.125 -3.296875 5.234375q-2.640625 2.109375 -5.78125 2.109375zm104.04126 -79.234375q-3.65625 0 -5.765625 -2.671875q-2.09375 -2.671875 -1.3125 -6.28125l0.109375 -0.5q0.703125 -3.359375 3.578125 -5.734375q2.875 -2.375 6.28125 -2.375l0.78125 0q3.65625 0 5.734375 2.671875q2.09375 2.671875 1.34375 6.28125l-0.109375 0.5q-0.71875 3.359375 -3.59375 5.734375q-2.859375 2.375 -6.265625 2.375l-0.78125 0zm-16.578125 79.234375q-3.40625 0 -5.3125 -2.40625q-1.890625 -2.421875 -1.171875 -5.78125l11.671875 -54.890625q0.671875 -3.25 3.234375 -5.359375q2.578125 -2.125 5.734375 -2.125q3.53125 0 5.421875 2.421875q1.890625 2.40625 1.171875 5.875l-11.671875 54.921875q-0.65625 3.109375 -3.234375 5.234375q-2.5625 2.109375 -5.84375 2.109375zm52.512634 0.640625q-2.4375 0 -5.765625 -0.484375q-3.3125 -0.484375 -6.453125 -2.359375q-3.140625 -1.890625 -4.6875 -5.953125q-1.53125 -4.0625 -0.15625 -10.515625l7.921875 -37.265625l-6.625 0q-4.890625 0 -3.859375 -4.859375q0.453125 -2.078125 2.375 -3.359375l20.9375 -16.953125q0.40625 -0.328125 1.359375 -0.96875q0.96875 -0.640625 2.34375 -0.640625q2.046875 0 3.140625 1.546875q1.09375 1.546875 0.6875 3.4375l-1.65625 7.8125l12.0 0q3.140625 0 4.84375 2.15625q1.71875 2.15625 1.046875 5.265625q-0.578125 2.703125 -2.84375 4.640625q-2.265625 1.921875 -5.171875 1.921875l-12.84375 0l-7.890625 37.0625q-0.609375 2.921875 -0.015625 3.875q0.609375 0.9375 2.0 1.171875q1.40625 0.234375 2.765625 0.234375q2.71875 0 4.3125 -0.578125q1.609375 -0.578125 3.609375 -0.578125q2.703125 0 4.46875 2.0q1.765625 2.0 1.109375 5.03125q-0.828125 3.90625 -5.046875 5.875q-2.71875 1.109375 -5.65625 1.796875q-2.9375 0.6875 -6.25 0.6875zm51.489746 0q-7.328125 0 -12.984375 -1.609375q-5.640625 -1.625 -10.265625 -4.53125q-2.875 -2.390625 -2.0625 -6.265625q0.5625 -2.546875 2.8125 -4.625q2.265625 -2.078125 5.21875 -2.078125q1.625 0 3.078125 0.71875q2.984375 1.453125 6.671875 2.546875q3.703125 1.09375 9.046875 1.09375q6.859375 0 10.140625 -2.0q3.28125 -2.0 4.046875 -5.515625q0.296875 -1.453125 -1.40625 -2.53125q-1.703125 -1.078125 -5.734375 -2.125q-4.03125 -1.046875 -8.765625 -2.296875q-4.71875 -1.25 -9.046875 -3.546875q-4.328125 -2.3125 -6.640625 -6.546875q-2.296875 -4.234375 -0.921875 -10.734375q2.015625 -9.421875 10.0625 -15.609375q8.046875 -6.1875 21.15625 -6.1875q5.453125 0 10.109375 0.9375q4.671875 0.9375 8.4375 2.375q2.484375 0.765625 3.4375 2.953125q0.96875 2.171875 0.53125 4.21875q-0.578125 2.703125 -2.921875 4.703125q-2.328125 2.0 -5.234375 2.0q-0.6875 0 -1.21875 -0.078125q-0.515625 -0.09375 -1.0625 -0.28125q-2.71875 -0.984375 -6.0625 -1.59375q-3.328125 -0.609375 -7.375 -0.609375q-6.484375 0 -10.265625 2.203125q-3.765625 2.203125 -4.40625 5.171875q-0.4375 2.09375 1.265625 3.390625q1.703125 1.28125 5.6875 2.3125q3.984375 1.03125 8.78125 2.21875q4.796875 1.1875 9.15625 3.5q4.359375 2.296875 6.625 6.609375q2.28125 4.296875 0.78125 11.296875q-1.8125 8.515625 -9.765625 14.515625q-7.953125 6.0 -20.90625 6.0zm66.59625 0q-7.984375 0 -12.9375 -3.8125q-4.9375 -3.8125 -6.5468445 -10.125q-1.59375 -6.328125 -0.0625 -13.578125l7.7187195 -36.34375q0.65625 -3.125 3.296875 -5.234375q2.640625 -2.109375 5.78125 -2.109375q3.40625 0 5.296875 2.421875q1.90625 2.40625 1.1875 5.765625l-7.453125 35.0625q-1.375 6.53125 0.578125 9.875q1.953125 3.328125 8.234375 3.328125q6.328125 0 11.921875 -3.5625q5.59375 -3.578125 9.84375 -7.734375l8.03125 -37.8125q0.65625 -3.125 3.296875 -5.234375q2.640625 -2.109375 5.78125 -2.109375q3.40625 0 5.296875 2.421875q1.90625 2.40625 1.1875 5.765625l-11.671875 54.90625q-0.65625 3.09375 -3.234375 5.28125q-2.5625 2.1875 -5.734375 2.1875q-3.40625 0 -5.359375 -2.46875q-1.953125 -2.484375 -1.234375 -5.84375l0.234375 0.0625q-0.875 1.09375 -7.625 5.0q-6.734375 3.890625 -15.828125 3.890625zm65.5614 -0.640625q-3.40625 0 -5.3125 -2.40625q-1.890625 -2.421875 -1.171875 -5.78125l11.671875 -54.890625q0.671875 -3.25 3.234375 -5.359375q2.578125 -2.125 5.734375 -2.125q3.359375 0 5.34375 2.40625q1.984375 2.390625 1.25 5.890625l-0.234375 -0.046875q1.03125 -1.21875 7.6875 -5.046875q6.65625 -3.84375 15.765625 -3.84375q7.984375 0 12.921875 3.8125q4.953125 3.796875 6.5625 10.0625q1.625 6.25 0.0625 13.640625l-7.71875 36.34375q-0.65625 3.125 -3.296875 5.234375q-2.640625 2.109375 -5.78125 2.109375q-3.40625 0 -5.3125 -2.40625q-1.890625 -2.421875 -1.171875 -5.78125l7.453125 -35.0625q1.390625 -6.546875 -0.515625 -9.875q-1.90625 -3.328125 -8.296875 -3.328125q-6.328125 0 -11.90625 3.5q-5.578125 3.5 -9.859375 7.796875l-8.03125 37.8125q-0.65625 3.140625 -3.3125 5.25q-2.640625 2.09375 -5.765625 2.09375zm105.2489 0.640625q-16.59375 0 -24.0625 -9.65625q-7.46875 -9.65625 -3.84375 -26.6875q1.90625 -9.046875 6.96875 -17.125q5.078125 -8.09375 13.328125 -13.234375q8.25 -5.140625 19.453125 -5.140625q10.546875 0 16.890625 4.96875q6.359375 4.953125 8.484375 12.8125q2.125 7.84375 0.203125 16.90625q-0.65625 3.078125 -3.15625 5.203125q-2.5 2.125 -5.921875 2.125l-41.5625 0q-0.5625 5.921875 3.265625 10.4375q3.84375 4.515625 13.28125 4.515625q5.515625 0 9.5 -1.03125q3.984375 -1.046875 7.796875 -2.765625q1.546875 -0.6875 3.25 -0.6875q2.953125 0 4.8125 2.125q1.859375 2.125 1.203125 5.265625q-0.453125 2.140625 -2.0 3.6875q-1.546875 1.53125 -3.40625 2.4375q-4.890625 2.5 -10.390625 4.171875q-5.484375 1.671875 -14.09375 1.671875zm-10.421875 -43.296875l33.4375 0q0.671875 -4.3125 -1.171875 -7.828125q-1.828125 -3.515625 -5.15625 -5.1875q-3.3125 -1.671875 -6.9375 -1.671875q-3.703125 0 -7.953125 1.765625q-4.234375 1.765625 -7.734375 5.515625q-3.5 3.75 -4.484375 7.40625zm64.60254 42.015625q-3.390686 0 -5.296936 -2.40625q-1.90625 -2.421875 -1.1875 -5.78125l16.515686 -77.6875q0.65625 -3.09375 3.21875 -5.28125q2.578125 -2.1875 5.734375 -2.1875l30.21875 0q14.953125 0 21.53125 7.109375q6.59375 7.09375 4.171875 18.484375q-1.8125 8.515625 -7.03125 13.671875q-5.203125 5.140625 -6.828125 5.4375q0.46875 -0.203125 4.25 2.90625q3.78125 3.109375 5.5 7.875q1.734375 4.75 0.359375 11.1875q-1.671875 7.890625 -6.46875 13.984375q-4.78125 6.078125 -13.109375 9.390625q-8.3125 3.296875 -20.59375 3.296875l-30.984375 0zm19.140625 -54.6875l18.78125 0q7.6875 0 12.125 -1.75q4.453125 -1.75 6.640625 -4.671875q2.203125 -2.921875 2.984375 -6.59375q1.03125 -4.859375 -2.359375 -7.8125q-3.375 -2.953125 -11.328125 -2.953125l-21.796875 0l-5.046875 23.78125zm-8.46875 39.8125l21.46875 0q8.484375 0 13.390625 -1.703125q4.90625 -1.71875 7.3125 -4.640625q2.421875 -2.921875 3.25 -6.796875q1.328125 -6.25 -2.9375 -9.203125q-4.265625 -2.96875 -14.65625 -2.96875l-22.4375 0l-5.390625 25.3125zm82.032104 14.875q-3.390625 0 -5.296875 -2.40625q-1.90625 -2.421875 -1.1875 -5.78125l16.515625 -77.6875q0.65625 -3.09375 3.21875 -5.28125q2.578125 -2.1875 5.734375 -2.1875l30.21875 0q14.953125 0 21.53125 7.109375q6.59375 7.09375 4.171875 18.484375q-1.8125 8.515625 -7.03125 13.671875q-5.203125 5.140625 -6.828125 5.4375q0.46875 -0.203125 4.25 2.90625q3.78125 3.109375 5.5 7.875q1.734375 4.75 0.359375 11.1875q-1.671875 7.890625 -6.46875 13.984375q-4.78125 6.078125 -13.109375 9.390625q-8.3125 3.296875 -20.59375 3.296875l-30.984375 0zm19.140625 -54.6875l18.78125 0q7.6875 0 12.125 -1.75q4.453125 -1.75 6.640625 -4.671875q2.203125 -2.921875 2.984375 -6.59375q1.03125 -4.859375 -2.359375 -7.8125q-3.375 -2.953125 -11.328125 -2.953125l-21.796875 0l-5.046875 23.78125zm-8.46875 39.8125l21.46875 0q8.484375 0 13.390625 -1.703125q4.90625 -1.71875 7.3125 -4.640625q2.421875 -2.921875 3.25 -6.796875q1.328125 -6.25 -2.9375 -9.203125q-4.265625 -2.96875 -14.65625 -2.96875l-22.4375 0l-5.390625 25.3125z" fill-rule="nonzero"/></g></svg> <b style="position:relative;bottom:20px"> v0.1.1</b>
<!--
<button type="button" onclick="loadDoc('request.log', 'demo')">View Log</button>
-->
<div id="blank" style="display:none"></div>
<div id="demo"></div>
<form>
<label for="uname">Username: </label>
<input type="text" id="uname" name="uname" /><br />
<label for="channel">Channel: </label>
<input type="text" id="channel" name="channel" value="general" />
<button type="button" onclick="setChannel()">Set</button>
<br />
<label for="pwd">Password: </label>
<input type="text" id="pwd" name="pwd" />
<button type="button" onclick="setPassword()">Set</button>
<br />
<!--button type="button" onclick="loadDoc('index.php?u=' + encodeURIComponent(document.getElementById('uname').value), 'blank')">Post</button> -->
<textarea id="msg" name="msg" rows="10" cols="30"></textarea>
<button type="button" id="post" onclick="postMsg()">Post</button><br />
<span id="reply"></span>

</form>
<script>

last = 0;
channel = document.getElementById("channel").value;
pwd = "";
reply = 0;
document.getElementById("msg").addEventListener("keypress", function(event) {
  if (event.key === "Enter") {
    event.preventDefault();
    document.getElementById("post").click();
  }
});


function setChannel() {
  channel = document.getElementById("channel").value;
  last = 0;
  document.getElementById("demo").innerHTML = "";
  update();
}

function setPassword() {
  pwd = document.getElementById("pwd").value;
  last = 0;
  document.getElementById("demo").innerHTML = "";
  update();
}


function loadDoc(str,target) {
  const xhttp = new XMLHttpRequest();
  xhttp.onload = function() {
    document.getElementById(target).innerHTML =
    this.responseText;
  }
  xhttp.open("GET", str, true);
  xhttp.send();
}


function encrypt(m) {
  m = (Math.random() + 1).toString(36).substring(7) + " " + m;
  return CryptoJS.AES.encrypt(m,pwd);
}

function decrypt(m) {
  d = CryptoJS.AES.decrypt(m,pwd);
  try {
    d = d.toString(CryptoJS.enc.Utf8);
    return d.substr(d.indexOf(" ") + 1); 
  } catch (e) {
    return "";
  }
}

function setReply(r) {
  reply = r;
  try {
  replytext = document.getElementById("msg" + reply).innerHTML;
  } catch (e) {
  replytext = "";
  }
  if (replytext.length > 15) {
    replytext = replytext.substr(0,15) + "...";
  }
  document.getElementById("reply").innerHTML = "Replying to <i>" + replytext + "</i>";
  document.getElementById("msg").focus();
}

function setReact(txt,r) {
  setReply(r);
  document.getElementById("msg").value = txt;
  postMsg();
}

function postMsg() {
  uname = document.getElementById("uname").value;
  uname = encrypt(uname);
  uname = encodeURIComponent(uname);
  msg = document.getElementById("msg").value;
  msg = encrypt(msg);
  msg = encodeURIComponent(msg);
  
  loadDoc("post.php?ch=" + 
    channel + "&u=" + 
    uname +
    "&msg=" + msg + "&reply=" + reply, "blank");
  reply = 0;
  document.getElementById("reply").innerHTML = "";
  document.getElementById("msg").value = "";
}

function update() {
  const xhttp = new XMLHttpRequest();
  xhttp.onload = function() {
    obj = JSON.parse(this.responseText);
    demo = document.getElementById("demo");
    if (obj.length > 0) {
      last = obj[obj.length-1]["id"];
    }
    for (row of obj)
    {
    title = document.createElement("div");
    title.className = "title";
    title_dec = decrypt(row["title"]);
    if (title_dec != "") {
    title.appendChild(document.createTextNode(title_dec + " - " + (new Date(row["time"] * 1000).toLocaleTimeString('en-US'))));
    }
    
    message = document.createElement("div");
    message.className = "message";
    message_dec = decrypt(row["message"]);
    messagetext = document.createElement("span");
    messagetext.appendChild(document.createTextNode(message_dec + " "));
    messagetext.id = "msg" + Number(row["id"]);
    replylink = document.createElement("a");
    replylink.href = "javascript:setReply(" + Number(row["id"]) + ")";
    replylink.appendChild(document.createTextNode("Reply"));
    message.appendChild(messagetext);
    message.appendChild(replylink);
    reactions = ["<3", "^u^", "T_T", ">\u76ca<"]
    for (let i = 0; i < reactions.length; i++) {
      reactlink = document.createElement("a");
      reactlink.href = "javascript:setReact(\"" + reactions[i] + "\"," + Number(row["id"]) + ")";
      reactlink.appendChild(document.createTextNode(reactions[i]));
      message.appendChild(document.createTextNode(" | "));
      message.appendChild(reactlink);
    }

    demo.appendChild(title);
    if (row["replyto"] != 0) {
	replyto = document.createElement("div");
	replyto.className = "reply";
	replymsg = "msg" + row["replyto"];
	try {
  		replytext = document.getElementById(replymsg).innerHTML;
  	} catch (e) {
  		replytext = "";
  	}
  	if (replytext.length > 15) {
    		replytext = replytext.substr(0,15) + "...";
 	 }
	replyto.appendChild(document.createTextNode(replytext));
	replytolink = document.createElement("a");
	replytolink.href = "#" + replymsg;
	replytolink.appendChild(replyto);
	if (replytext != "") {
		demo.appendChild(replytolink);
	}
    }
    if (message_dec != "") {
      demo.appendChild(message);
    }
    demo.scrollTop = demo.scrollHeight;
    }
  }
  xhttp.open("GET", "update.php?from=" + encodeURIComponent(last) + "&ch=" + encodeURIComponent(channel), true);
  xhttp.send();
}
</script>

</body>
</html>
